---
layout: post
title: springcloud（一）
date: 2021-04-16 13:10:22
categories: springcloud
tags: springcloud
author: MarsHu
---

* content
{:toc}

### 使用Eureka搭建注册中心  ###
按照图示,创建maven项目:
![springcloud1-1.png](http://marshucheng1.github.io/assets/springcloud/springcloud1-1.png)







![springcloud1-2.png](http://marshucheng1.github.io/assets/springcloud/springcloud1-2.png)

![springcloud1-3.png](http://marshucheng1.github.io/assets/springcloud/springcloud1-3.png)

![springcloud1-4.png](http://marshucheng1.github.io/assets/springcloud/springcloud1-4.png)

创建好项目,启动后控制台出现如下错误:

	com.netflix.discovery.shared.transport.TransportException: Cannot execute request on any known server

这个错误是eureka server启动后,自己连接自己导致报错。

改造当前的maven项目,按图示,让单体项目变成多module项目:

![springcloud1-5.png](http://marshucheng1.github.io/assets/springcloud/springcloud1-5.png)

![springcloud1-6.png](http://marshucheng1.github.io/assets/springcloud/springcloud1-6.png)

![springcloud1-7.png](http://marshucheng1.github.io/assets/springcloud/springcloud1-7.png)

创建好eureka子module后,复制父module项目course中pom.xml中的如下依赖:

	<dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
    </dependency>

将上面复制的依赖,添加到子module项目eureka中的pom.xml中,并将之从父module的pom.xml中删除:

	<dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
        </dependency>
    </dependencies>

在子module项目eureka的src/main/java目录下创建com.course包路径,并将父module项目course中src/main/java/com.zhqx.course包下的CourseApplication类复制到其中,然后将类名改为EurekaApplication。

将父module项目course中的src文件夹删掉。

### 搭建业务模块-system  ###
> **修改子项目eureka,使之能够正常运行:**

在子module项目eureka下的src/main/resources目录下新建application.properties文件,内容如下:

	spring.application.name=eureka
	server.port=8761
	eureka.client.fetch-registry=false
	eureka.client.register-with-eureka=false

在在子module项目eureka下的src/main/resources目录下新建logback.xml:

	<?xml version="1.0" encoding="UTF-8"?>
	<configuration>
	    <property name="PATH" value="/log/zhqx/course/eureka"></property>
	
	    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
	        <encoder>
	            <Pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %highlight(%-5level) %blue(%-50logger{50}:%-4line) %msg%n</Pattern>
	        </encoder>
	    </appender>
	
	    <appender name="TRACE_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
	        <file>${PATH}/trace.log</file>
	        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
	            <FileNamePattern>${PATH}/trace.%d{yyyy-MM-dd}.%i.log</FileNamePattern>
	            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
	                <maxFileSize>10MB</maxFileSize>
	            </timeBasedFileNamingAndTriggeringPolicy>
	        </rollingPolicy>
	        <layout>
	            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level %-50logger{50}:%-4line %green(%-8X{UUID}) %msg%n</pattern>
	        </layout>
	    </appender>
	
	    <appender name="ERROR_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
	        <file>${PATH}/error.log</file>
	        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
	            <FileNamePattern>${PATH}/error.%d{yyyy-MM-dd}.%i.log</FileNamePattern>
	            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
	                <maxFileSize>10MB</maxFileSize>
	            </timeBasedFileNamingAndTriggeringPolicy>
	        </rollingPolicy>
	        <layout>
	            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level %-50logger{50}:%-4line %green(%-8X{UUID}) %msg%n</pattern>
	        </layout>
	        <filter class="ch.qos.logback.classic.filter.LevelFilter">
	            <level>ERROR</level>
	            <onMatch>ACCEPT</onMatch>
	            <onMismatch>DENY</onMismatch>
	        </filter>
	    </appender>
	
	    <root level="ERROR">
	        <appender-ref ref="ERROR_FILE" />
	    </root>
	
	    <root level="TRACE">
	        <appender-ref ref="TRACE_FILE" />
	    </root>
	
	    <root level="INFO">
	        <appender-ref ref="STDOUT" />
	    </root>
	</configuration>

修改子module项目eureka项目中的启动类EurekaApplication:

	package com.course;
	
	import org.slf4j.Logger;
	import org.slf4j.LoggerFactory;
	import org.springframework.boot.SpringApplication;
	import org.springframework.boot.autoconfigure.SpringBootApplication;
	import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;
	import org.springframework.core.env.ConfigurableEnvironment;
	
	@SpringBootApplication
	@EnableEurekaServer
	public class EurekaApplication {
	
	    private static final Logger LOG = LoggerFactory.getLogger(EurekaApplication.class);
	
	    public static void main(String[] args) {
	        SpringApplication app = new SpringApplication(EurekaApplication.class);
	        ConfigurableEnvironment env = app.run(args).getEnvironment();
	        LOG.info("启动成功！！");
	        LOG.info("Eureka地址: \thttp://127.0.0.1:{}", env.getProperty("server.port"));
	    }
	
	}

启动项目,项目可以正常启动。

> **搭建业务模块-system,并将其注册到eureka服务中**

按照上面的步骤,创建新的子module项目system。在system项目的pom.xml中添加如下依赖:

	<dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
    </dependencies>

在system项目中新增配置文件application.properties

	spring.application.name=system
	server.port=9001
	eureka.client.service-url.defaultZone=http://localhost:8761/eureka/

新增日志配置logback.xml,与eureka项目中的日志文件一样,只要改一下输出路径即可:

	<property name="PATH" value="/log/zhqx/course/system"></property>

新增启动类:

	package com.course.system;
	
	import org.slf4j.Logger;
	import org.slf4j.LoggerFactory;
	import org.springframework.boot.SpringApplication;
	import org.springframework.boot.autoconfigure.SpringBootApplication;
	import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
	import org.springframework.core.env.ConfigurableEnvironment;
	
	@SpringBootApplication
	@EnableEurekaClient
	public class SystemApplication {
	
	    private static final Logger LOG = LoggerFactory.getLogger(SystemApplication.class);
	
	    public static void main(String[] args) {
	        SpringApplication app = new SpringApplication(SystemApplication.class);
	        ConfigurableEnvironment env = app.run(args).getEnvironment();
	        LOG.info("启动成功！！");
	        LOG.info("System地址: \thttp://127.0.0.1:{}", env.getProperty("server.port"));
	    }
	
	}


新增TestController

	package com.course.system.controller;
	
	import org.springframework.web.bind.annotation.RequestMapping;
	import org.springframework.web.bind.annotation.RestController;
	
	@RestController
	public class TestController {
	
	    @RequestMapping("/test")
	    public String test() {
	        return "success";
	    }
	}


### 搭建路由模块-gateway  ###
按照上面的步骤创建子module项目gateway。添加如下依赖:

	<dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-gateway</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>
    </dependencies>


在gateway项目中新增配置文件application.properties

	spring.application.name=gateway
	server.port=9000
	eureka.client.service-url.defaultZone=http://localhost:8761/eureka/

新增日志配置logback.xml,与eureka项目中的日志文件一样,只要改一下输出路径即可:

	<property name="PATH" value="/log/zhqx/course/gateway"></property>

新增启动类:

	package com.course.gateway;
	
	import org.slf4j.Logger;
	import org.slf4j.LoggerFactory;
	import org.springframework.boot.SpringApplication;
	import org.springframework.boot.autoconfigure.SpringBootApplication;
	import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
	import org.springframework.core.env.ConfigurableEnvironment;
	
	@SpringBootApplication
	@EnableEurekaClient
	public class GatewayApplication {
	
	    private static final Logger LOG = LoggerFactory.getLogger(GatewayApplication.class);
	
	    public static void main(String[] args) {
	        SpringApplication app = new SpringApplication(GatewayApplication.class);
	        ConfigurableEnvironment env = app.run(args).getEnvironment();
	        LOG.info("启动成功！！");
	        LOG.info("Gateway地址: \thttp://127.0.0.1:{}", env.getProperty("server.port"));
	    }
	
	}

在application.properties中增加配置路由配置,可以通过gateway服务访问system,从而达到隐藏system真实请求地址的目的.

	spring.application.name=gateway
	server.port=9000
	eureka.client.service-url.defaultZone=http://localhost:8761/eureka/
	
	# 路由转发
	spring.cloud.gateway.routes[0].id=system
	spring.cloud.gateway.routes[0].uri=http://127.0.0.1:9001
	spring.cloud.gateway.routes[0].predicates[0].name=Path
	spring.cloud.gateway.routes[0].predicates[0].args[0]=/system/**


修改system项目的配置文件,为所有请求添加前缀/system。

	spring.application.name=system
	server.servlet.context-path=/system
	server.port=9001
	eureka.client.service-url.defaultZone=http://localhost:8761/eureka/

依次将eureka、system、gateway启动。浏览器访问:http://127.0.0.1:9000/system/test,发现可以正常访问。